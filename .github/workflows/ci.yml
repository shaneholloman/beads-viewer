name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        
    - name: Build
      run: go build -v ./cmd/bv
      
    - name: Test with Coverage
      run: go test -v -covermode=atomic -coverprofile=coverage.out ./...

    - name: Enforce Coverage Threshold (project)
      run: |
        total=$(go tool cover -func=coverage.out | tail -1 | awk '{print $3}' | tr -d '%')
        echo "Total coverage: ${total}% (threshold 60%)"
        awk -v c="$total" 'BEGIN { if (c < 60.0) { printf("Coverage %.2f%% is below 60%%\n", c); exit 1 } }'

    - name: Enforce Coverage Thresholds (per-package, coarse)
      run: |
        set -e
        go tool cover -func=coverage.out | grep '^github.com/Dicklesworthstone/beads_viewer/pkg/' | awk '{print $1, $3}' > pkgcov.txt
        while read -r path pct; do
          pct=${pct%\%}
          req=
          case "$path" in
            github.com/Dicklesworthstone/beads_viewer/pkg/analysis) req=75 ;;
            github.com/Dicklesworthstone/beads_viewer/pkg/export) req=95 ;;
            github.com/Dicklesworthstone/beads_viewer/pkg/recipe) req=90 ;;
            github.com/Dicklesworthstone/beads_viewer/pkg/ui) req=55 ;;
            github.com/Dicklesworthstone/beads_viewer/pkg/loader) req=80 ;;
            github.com/Dicklesworthstone/beads_viewer/pkg/updater) req=70 ;;
            github.com/Dicklesworthstone/beads_viewer/pkg/watcher) req=80 ;;
            github.com/Dicklesworthstone/beads_viewer/pkg/workspace) req=85 ;;
          esac
          if [ -n "$req" ]; then
            below=$(awk -v p="$pct" -v r="$req" 'BEGIN { print (p < r) ? 1 : 0 }')
            if [ "$below" -eq 1 ]; then
              echo "Coverage for $path is ${pct}% (< ${req}%)"
              exit 1
            fi
          fi
        done < pkgcov.txt
        echo "Per-package thresholds OK"

    - name: Coverage Report Artifact
      run: |
        go tool cover -html=coverage.out -o coverage.html
      
    - name: Upload Coverage Artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.html

    - name: Upload to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: coverage.out
        flags: unittests
        name: codecov-coverage
        fail_ci_if_error: false
        verbose: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Run Quick Benchmarks
      run: |
        echo "Running critical benchmarks to catch performance regressions..."
        go test -bench='BenchmarkFullAnalysis_(Sparse100|Dense100|ManyCycles20)' \
                -benchmem -count=1 ./pkg/analysis/...

    - name: Verify Timeout Protection
      run: |
        echo "Verifying timeout protection prevents hangs..."
        go test -v -run='TestTimeoutProtection' ./pkg/analysis/... -timeout 30s
